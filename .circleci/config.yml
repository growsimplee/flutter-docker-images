version: 2.1

jobs:
  build-flutter:
    docker:
      - image: cimg/base:stable
    parameters:
      flutter_folder:
        type: string
    steps:
      - checkout

      - setup_remote_docker:
          resource_class: large

      - run:
          name: DockerHub Login
          command: echo "$DOCKERHUB_PASS" | docker login -u "$DOCKERHUB_USER" --password-stdin

      - run:
          name: Build & Push Flutter Docker Image
          command: |
            set -e
            FOLDER=<< parameters.flutter_folder >>
            VERSION_FILE="$FOLDER/versions"

            # Read current version (do not modify file yet)
            CURRENT_VERSION=$(cat $VERSION_FILE)
            NEW_VERSION=$((CURRENT_VERSION + 1))
            echo "Building Docker image version: $NEW_VERSION"

            docker build -f $FOLDER/Dockerfile \
              -t $DOCKERHUB_USER/${FOLDER#*/}:latest \
              -t $DOCKERHUB_USER/${FOLDER#*/}:$NEW_VERSION .

            docker push $DOCKERHUB_USER/${FOLDER#*/}:latest
            docker push $DOCKERHUB_USER/${FOLDER#*/}:$NEW_VERSION

      - run:
          name: Commit Version Bump & Create PR
          command: |
            set -e
            FOLDER=<< parameters.flutter_folder >>
            VERSION_FILE="$FOLDER/versions"

            # Read and increment version
            CURRENT_VERSION=$(cat "$VERSION_FILE")
            NEW_VERSION=$((CURRENT_VERSION + 1))
            echo "$NEW_VERSION" > "$VERSION_FILE"

            # Configure Git
            git config --global user.email "circleci-bot@yourproject.com"
            git config --global user.name "CircleCI Bot"

            # Create a new branch for the version bump
            BRANCH_NAME="update-version-$(basename $FOLDER)"
            git checkout -b "$BRANCH_NAME"

            # Stage, commit, and push
            git add "$VERSION_FILE"
            git commit -m "Bump version for $FOLDER to $NEW_VERSION"

            git push https://$GITHUB_ACCESS_TOKEN@github.com/$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME.git "$BRANCH_NAME"

            # Create PR using gh CLI
            gh pr create \
              --title "Bump $FOLDER version to $NEW_VERSION" \
              --body "Automatic version bump by CI" \
              --base main \
              --head "$BRANCH_NAME"

workflows:
  build:
    jobs:
      - build-flutter:
          name: build-flutter-3-24-2
          flutter_folder: flutter-3.24.2
          filters:
            branches:
              only: build-flutter-3.24.2

      - build-flutter:
          name: build-flutter-3-27-0
          flutter_folder: flutter-3.27.0
          filters:
            branches:
              only: build-flutter-3.27.0
